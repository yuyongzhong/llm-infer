# VLLM-MUSA CI 使用指南

本目录包含用于 VLLM-MUSA 持续集成测试的脚本和配置文件。

## 文件说明

### Groovy 流水线文件
- `vllm-server.groovy` - 服务部署流水线，用于部署 VLLM 服务并自动触发测试
- `vllm-test.groovy` - 测试流水线，用于运行精度和性能测试
- `vllm-test-image.groovy` - 镜像构建流水线

### 脚本文件
- `startup.sh` - VLLM 服务启动脚本，启动 DeepSeek 和 Qwen 服务
- `test.sh` - 测试执行脚本，运行精度测试

### 日志目录
- `logs/service-logs/` - 服务日志目录
- `logs/test-logs/` - 测试日志目录

## 使用方法

### 1. 启动 VLLM 服务

```bash
# 在服务容器中执行
sudo docker exec vllm-server-0806 bash /mnt/vllm/yuyongzhong/vllm-musa-ci/startup.sh
```

服务启动后：
- DeepSeek 服务：`http://127.0.0.1:8000`
- Qwen 服务：`http://127.0.0.1:8001`

### 2. 运行测试

```bash
# 在测试容器中执行
sudo docker exec vllm-test-0805 bash /mnt/vllm/yuyongzhong/vllm-musa-ci/test.sh
```

### 3. 查看日志

```bash
# 查看服务日志
sudo docker exec vllm-server-0806 tail -f /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/service-logs/deepseek-<LOG_NAME>.log
sudo docker exec vllm-server-0806 tail -f /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/service-logs/qwen-<LOG_NAME>.log

# 查看测试日志
sudo docker exec vllm-test-0805 tail -f /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/test-logs/deepseek-<LOG_NAME>.log
sudo docker exec vllm-test-0805 tail -f /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/test-logs/qwen-<LOG_NAME>.log
```

## Jenkins 流水线

### 服务部署流水线 (vllm-server.groovy)

**参数：**
- `SERVICE_HARBOR_IMAGE_URL`: 服务镜像地址
- `SERVICE_NODE_LABELS`: 执行节点
- `SERVICE_FORCE_PULL`: 是否强制拉取镜像
- `IS_TEST`: 是否自动触发测试

**功能：**
1. 拉取和验证服务镜像
2. 部署 VLLM 服务容器
3. 启动 DeepSeek 和 Qwen 服务
4. 可选择自动触发测试流水线

### 测试流水线 (vllm-test.groovy)

**参数：**
- `HARBOR_IMAGE_URL`: 测试镜像地址
- `NODE_LABELS`: 执行节点
- `RECREATE_CONTAINER`: 是否重新创建容器
- `LOG_MONITOR_DURATION`: 日志监控时间

**功能：**
1. 拉取和验证测试镜像
2. 创建测试容器
3. 运行精度测试
4. 生成测试报告

## 配置说明

### 环境变量
- `LOG_NAME`: 日志文件名标识，格式 `YYYYMMDD_HHMMSS`
- `HOME_PATH`: 代码根目录，默认 `/mnt/vllm/yuyongzhong`

### 容器名称
- 服务容器：`vllm-server-0806`
- 测试容器：`vllm-test-0805`

### 端口分配
- DeepSeek 服务：8000
- Qwen 服务：8001

## 故障排查

### 1. 服务启动失败
检查服务日志：
```bash
sudo docker exec vllm-server-0806 cat /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/service-logs/deepseek-<LOG_NAME>.log
```

### 2. 测试失败
检查测试日志：
```bash
sudo docker exec vllm-test-0805 cat /mnt/vllm/yuyongzhong/vllm-musa-ci/logs/test-logs/deepseek-<LOG_NAME>.log
```

### 3. API 连接问题
测试 API 连接：
```bash
curl http://127.0.0.1:8000/v1/models
curl http://127.0.0.1:8001/v1/models
```

### 4. 容器状态检查
```bash
sudo docker ps | grep vllm
sudo docker logs vllm-server-0806
sudo docker logs vllm-test-0805
```

## 注意事项

1. 确保模型文件存在于 `/mnt/models/` 目录
2. 确保有足够的 GPU 内存运行多个模型
3. 日志文件会持续增长，注意磁盘空间
4. 测试过程中不要停止服务容器

## 更新记录

- 2025-08-19: 修复配置文件路径适配问题
- 2025-08-19: 添加标准化 JSON 输出功能
- 2025-08-19: 优化错误处理和日志输出
